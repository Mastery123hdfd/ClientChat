<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WebSocket Client</title>
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="VerdantLogo.png">


    <style>
        body {
            background: rgb(18, 19, 27);
            font-family: 'Comfortaa', sans-serif;
            font-size: 14px;
            color: white;
            padding: 20px;
        }

        #log {
            border: 1px solid #ffffff;
            background: #222;
            padding: 10px;
            color: white;
            height: 400px;
            overflow-y: auto;
            border-radius: 6px;
            box-shadow: inset 0 0 6px #0d0b24;
        }

        .inputbox {
            width: 300px;
            padding: 8px;
            background: #333;
            color: white;
            border: 1px solid #ffffff;
            border-radius: 6px;
            box-shadow: inset 0 0 4px #000;
            font-family: 'Comfortaa', sans-serif;
            font-size: 14px;
        }

        .btn {
            padding: 8px 14px;
            margin-left: 6px;
            background: #2c2c2c;
            color: rgb(255, 255, 255);
            border: 1px solid #ffffff;
            border-radius: 6px;
            font-family: 'Comfortaa', sans-serif;
            cursor: pointer;
            box-shadow: inset 0 0 4px #202020;
        }

        .btn:hover {
            background: #555;
        }

        .chat {
            color: white;
        }

        .system {
             color: #7ec8ff;
            font-style: italic;
        }


    </style>
</head>
<body>

<h2>WebSocket Client</h2>

<div id="log"></div>

<br>

<input id="msg" class = "inputbox" placeholder="Type a message">
<button id = "clickbutton" class = "btn" onclick="sendMessage()">Send</button>
<input id = "prinput" class = "inputbox" placeholder = "Type in pr tag">
<button id="prSwitch" class = "btn" onclick="changePR()">Change Private Room</button>
    
<br>
<hr style="margin: 20px 0; border: 1px solid #444;">
    
<input id = "usernameIn" class = "inputbox" placeholder = "Username">
<input id = "passIn" class = "inputbox" placeholder = "Password">
<button id="loginButton" class = "btn" onclick = "InitLogin()">Login / Signup - WORK IN PROGRESS</button>

<script type = "module">
    
    console.log("SCRIPT LOADED", Date.now());

    const logBox = document.getElementById("log");
    
    const ws = new WebSocket("wss://clientservertestexp.onrender.com");
    const box = document.getElementById("msg");
    const btn = document.getElementById("clickbutton");
    const prin = document.getElementById("prinput");
    const prout = document.getElementById("prSwitch");
    const userin = document.getElementById("usernameIn");
    const passin = document.getElementById("passIn");
    const loginbutton = document.getElementById("loginButton");
    
    let prtag = "main";
    let firstlogin = true;
    let token = null;
    if(firstlogin){
        t = localStorage.getItem("sessionToken");
        if(t){
            token = t;
        }
        
    }
    box.addEventListener("keydown", function (event) {
        if (event.key === "Enter") {
            btn.click();   
        }
    });


    function changePR(){
        const packet = JSON.stringify({
            type: "changePrTag",
            v1: prin.value
        });
        prtag = prin.value;
        document.getElementById("log").innerHTML = "";
        ws.send(packet);
        prin.value = "";

    }
   
    
    
    function log(text, type = "chat") {
        const p = document.createElement("p");
        p.textContent = text;
        if (type === "system") {
            p.classList.add("system");
        } else {
            p.classList.add("chat");
            p.dataset.chat = "true";
        }
        logBox.appendChild(p);
        const scrollCheck = logBox.scrollHeight - logBox.scrollTop - logBox.clientHeight < 100;

        if (scrollCheck) {
            logBox.scrollTop = logBox.scrollHeight;
        }


    }
    function Login(user, pass){
        LoginPacket = (JSON.stringify({
            type: "login",
            msg:null,
            tag:null,
            v1:user,
            v2:pass
        }));
        log("LoginSent");
        log(LoginPacket.toString());
        ws.send(LoginPacket);
    }
    function InitLogin(){
        Login(userin.value, passin.value);
        firstlogin=false;
    }


    ws.onopen = () => {
        console.log("CLIENT: ws.onopen fired");

        log("Connected to server");
        const token = localStorage.getItem("sessionToken");
        if (token) {
            ws.send(JSON.stringify({
                type: "sessionrestart",
                token: token
            }));
        }
    };

    ws.onmessage = (event) => {
        try{
        const data = JSON.parse(event.data);

            if (data.type == "clearHistory") {
                document.getElementById("log").innerHTML = "";
                log("Chat cleared by admin");
                return;
            }
            if(data.type == "clearHistoryChatless"){
                document.getElementById("log").innerHTML = "";
                return;
            }
            else if(data.type == "strikemsg"){
                const messages = logBox.querySelectorAll("[data-chat='true']");
                const last = messages[messages.length - 1]; 
                if (last) last.remove();
                return;
            }
            else if(data.type == "sessionToken"){
                token = data.tokenid;
                localStorage.setItem("sessionToken", data.tokenid);
            }
            else{
                const output = data.message;
                log("" + output, "chat");
            }

        } catch(e){
            log("" + event.data, "system");
        }
        
    };

    ws.onclose = () => {
        log("Connection closed. Retrying in 3 seconds...");
        setTimeout(() => location.reload(), 3000);
    };

    ws.onerror = (err) => {
        log("WebSocket error");
        console.error(err);
    };

    function sendMessage() {
        
        const text = document.getElementById("msg").value;
        if(text.trim() == ""){
            return;
        }
        const data = (JSON.stringify({type: "empty", msg: text, tag: prtag}));
        ws.send(data);
        document.getElementById("msg").value = "";
    }
</script>

</body>
</html>
